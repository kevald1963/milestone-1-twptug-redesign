{% extends 'base.html' %}
{% block content %}

    <section class="row">

        <!-- CALENDAR BODY -->
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
            <div class="calendar-container">
                <div class="calendar">
                    <div class="month">
                        <i class="fas fa-angle-left prev"></i>
                        <div class="date">
                            <h1></h1>
                            <p></p>
                        </div>
                        <i class="fas fa-angle-right next"></i>
                    </div>

                    <div class="weekdays">
                        <div>Sun</div>
                        <div>Mon</div>
                        <div>Tue</div>
                        <div>Wed</div>
                        <div>Thu</div>
                        <div>Fri</div>
                        <div>Sat</div>
                    </div>

                    <div class="days">
                        <div class="prev-date">26</div>
                        <div class="prev-date">27</div>
                        <div class="prev-date">28</div>
                        <div class="prev-date">29</div>
                        <div class="prev-date">30</div>
                        {% for i in range(1, 32) %}
                            <div id="{{ i }}">{{ i }}</div>
                        {% endfor %}
                        <div class="date-next">1</div>
                        <div class="date-next">2</div>
                        <div class="date-next">3</div>
                        <div class="date-next">4</div>
                        <div class="date-next">5</div>
                        <div class="date-next">6</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- EVENT PANEL -->
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
            <div class="home-page-news">
                <span id="panel-title" class="uppercase panel-title"></span><br><br>
                <div id="event_details" class="event_details">
                     <!-- Event details placed here by javascript. -->
                </div>
            </div>
        </div>

    </section>

    <script>
        //
        // Check day of month from events table in database and mark those dates on calendar.
        //
        let events = {{ events|safe }};
        let day_of_month = [];

        for (let item of events) {
            day_of_month.push(item.day_of_month);
            document.getElementById(item.day_of_month.toString()).setAttribute("class", "event");
        };
    </script>

    <script>
        function removeAllChildNodes(parent) {
            while (parent.firstChild) {
                parent.removeChild(parent.firstChild);
            };
        };
    </script>

    <script>
        //
        // Display event information when a day is clicked for the currently displayed month.
        //
        document.addEventListener('click', function(e) {
            let elemClass = document.getElementById(e.target.id).getAttribute("class");
            if (elemClass == "event" || elemClass == "event-today") {
                let events = {{ events|safe }};
                let target_id = e.target.id;
                let title = [];
                let description = [];
                let event_date = [];
                let time = [];
                events.forEach(function(item) {
                    if (item.day_of_month == target_id) {
                        event_date.push(item.event_date);

                        // Get the event date from first record and display in event panel title.
                        // Convert it to U.S. format first so it can be converted to a date string
                        // correctly, e.g. "Sat Jan 02 2021".
                        var date = item.event_date.split("/");
                        var d = parseInt(date[0], 10),
                            m = parseInt(date[1], 10),
                            y = parseInt(date[2], 10);
                        new Date(y, m - 1, d);
                        var selected_date = new Date(y, m - 1, d).toDateString();
                        document.getElementById("panel-title").innerHTML = "Events for " + selected_date;

                        // Extract the remaining fields from the JSON object and display the
                        // details of all events for the selected date.
                        title.push(item.title);
                        description.push(item.description);
                        time.push(item.event_time);

                        // Find the parent element under which the event details will be placed.
                        var parentElem = document.getElementById("event_details");

                        // Call function to remove any existing child paragraphs under the parent,
                        //otherwise previous event details will keep appending to it.
                        removeAllChildNodes(parentElem);

                        for(var i = 0; i < title.length; i += 1) {

                            var pElemTitle = document.createElement("p");
                            pElemTitle.className = "title";
                            pElemTitle.innerHTML = "Title: " + title[i];
                            parentElem.appendChild(pElemTitle);

                            var pElemDescription = document.createElement("p");
                            pElemDescription.className = "description";
                            pElemDescription.innerHTML = "Description: " + description[i];
                            parentElem.appendChild(pElemDescription);

                            var pElemTime = document.createElement("p");
                            pElemTime.className = "time";
                            pElemTime.innerHTML = "Time: " + time[i];
                            parentElem.appendChild(pElemTime);

                            // Create a break between separate events for better readability.
                            var pElemBreak = document.createElement("br");
                            parentElem.appendChild(pElemBreak);
                        };
                    };
                });
            };
        });
    </script>

    <script src='static/js/script.js' type="text/javascript"></script>

{% endblock %}
